<div class="character-detail-wrapper" *ngIf="character$ | async as character">
  
  <!-- Mobile Back Button (visible on mobile only) -->
  <div class="mobile-back-button-wrapper">
    <button class="mobile-back-button" (click)="goBack()" title="Back to Characters">
      <span class="back-icon">‚Üê</span>
      <span class="back-text">Back</span>
    </button>
  </div>

  <!-- Tab Navigation Bar -->
  <div class="tab-navigation">
    <button class="back-button-tab" (click)="goBack()" title="Back to Characters">
      <span class="back-icon">‚Üê</span>
    </button>
    <button class="tab-button" 
            [class.active]="selectedTab === 'personal'"
            (click)="selectTab('personal')">
      <span class="tab-icon">üë§</span>
      Overview
    </button>
    <button class="tab-button" 
            [class.active]="selectedTab === 'biography'"
            (click)="selectTab('biography')">
      <span class="tab-icon">üìñ</span>
      Biography
    </button>
    <button class="tab-button" 
            [class.active]="selectedTab === 'supports'"
            (click)="selectTab('supports')">
      <span class="tab-icon">üí¨</span>
      Supports
    </button>
    <button class="tab-button" 
            [class.active]="selectedTab === 'skills'"
            (click)="selectTab('skills')">
      <span class="tab-icon">‚≠ê</span>
      Skills
    </button>
  </div>

  <!-- Main Content Area -->
  <div class="character-content">
    
    <!-- Character Portrait Sidebar (appears on all tabs) -->
    <div class="character-sidebar">
      
      <!-- Portrait Card -->
      <div class="portrait-card">
        <div class="portrait-frame">
          <div class="portrait-image">
            <span class="portrait-placeholder">üì∑</span>
          </div>
        </div>
        <div class="character-name">{{ character.biography?.name }}</div>
      </div>

      <!-- Class & Level Info -->
      <div class="class-info-card">
        <div class="class-name clickable" (click)="openClassDetailModal()" title="View Class Details">
          {{ character.currentClass?.name }}
        </div>
        <div class="level-exp-row" [title]="'Internal Level: ' + character.internalLevel">
          <div class="level-info">
            <span class="label">LV</span>
            <span class="value">{{ character.level }}</span>
          </div>
          <div class="exp-info" (click)="openExpDialog()" style="cursor: pointer;" title="Update Experience">
            <span class="label">Exp</span>
            <span class="value">{{ character.exp }}</span>
          </div>
        </div>
        
        <!-- HP Display -->
        <div class="hp-row">
          <div class="hp-main">
            <span class="hp-label">HP</span>
            <div class="hp-value-group">
              <input *ngIf="isEditingHP" 
                     type="number" 
                     [(ngModel)]="editableCurrentHP"
                     class="hp-input"
                     (blur)="saveHP()"
                     (keyup.enter)="saveHP()"
                     (keyup.escape)="cancelEditingHP()">
              <span *ngIf="!isEditingHP" 
                    class="hp-current"
                    [class.maxed]="isHPMaxed()"
                    (click)="startEditingHP()">
                {{ character.currentHP }}
              </span>
              <span class="hp-separator">/</span>
              <span class="hp-max" [class.maxed]="isHPMaxed()">{{ character.currentStats?.hp }}</span>
            </div>
          </div>
          <div class="hp-growth" *ngIf="character.totalGrowthRate?.hp">
            <span class="growth-label">GROWTH</span>
            <span class="growth-value-boxed">{{ character.totalGrowthRate.hp }}%</span>
          </div>
        </div>

        <div class="gold-row" (click)="openGoldDialog()" style="cursor: pointer;" title="Update Gold">
          <span class="gold-label">Gold</span>
          <span class="gold-value">{{ character.gold }}</span>
        </div>
      </div>

      <!-- Combat Stats Card -->
      <div class="combat-stats-card">
        <h3 class="card-title">Combat</h3>
        <div class="combat-stats-grid">
          <div class="combat-stat-item">
            <span class="stat-label">{{ character.equippedWeapon?.weaponType?.toLowerCase().includes('staff') ? 'Heal' : 'Atk' }}</span>
            <span class="stat-value">{{ character.equippedWeapon?.weaponType?.toLowerCase().includes('staff') ? character.heal : character.attack }}</span>
          </div>
          <div class="combat-stat-item">
            <span class="stat-label">Dmg</span>
            <span class="stat-value">{{ character.damage }}</span>
          </div>
          <div class="combat-stat-item">
            <span class="stat-label">Crit</span>
            <span class="stat-value">{{ character.crit }}</span>
          </div>
          <div class="combat-stat-item">
            <span class="stat-label">Hit</span>
            <span class="stat-value">{{ character.equippedWeapon?.hit || 0 }}</span>
          </div>
          <div class="combat-stat-item">
            <span class="stat-label">Avo</span>
            <span class="stat-value">{{ character.avoid }}</span>
          </div>
          <div class="combat-stat-item">
            <span class="stat-label">Ddg</span>
            <span class="stat-value">{{ character.dodge }}</span>
          </div>
          <div class="combat-stat-item">
            <span class="stat-label">AS</span>
            <span class="stat-value">{{ character.attackSpeed }}</span>
          </div>
          <div class="combat-stat-item">
            <span class="stat-label">DStk</span>
            <span class="stat-value">{{ character.dualStrike }}</span>
          </div>
          <div class="combat-stat-item">
            <span class="stat-label">DGrd</span>
            <span class="stat-value">{{ character.dualGuard }}</span>
          </div>
        </div>
        <div class="unit-types-section" *ngIf="character.unitTypes && character.unitTypes.length > 0">
          <div class="unit-type-badge" *ngFor="let type of character.unitTypes">{{ type }}</div>
        </div>
      </div>
    </div>

    <!-- Tab Content Area -->
    <div class="tab-content">
      
      <!-- Personal Data Tab -->
      <div class="tab-panel" *ngIf="selectedTab === 'personal'">
        <div class="personal-data-grid">
          
          <!-- Column 1: Stats with Growth Rates -->
          <div class="stats-column">
            <div class="stats-header-row">
              <h2 class="section-header">Stats</h2>
              <h2 class="section-header growth-header">Growth</h2>
            </div>
            
            <div class="stats-subheader-row">
              <span class="stat-label-header"></span>
              <div class="stat-data-headers">
                <span>Current</span>
                <span>Base</span>
                <span>Max</span>
              </div>
            </div>
            
            <div class="stat-row" *ngIf="character.currentStats">
              <span class="stat-name">Str</span>
              <div class="stat-data">
                <div class="stat-current-col">
                  <span class="stat-value" [class.maxed]="isBaseStatMaxed(character, 'str')">
                    {{ character.currentStats?.str || 0 }}
                  </span>
                </div>
                <div class="stat-base-col">
                  <div class="stat-value-group">
                    <span class="stat-base" [class.maxed]="isBaseStatMaxed(character, 'str')">
                      {{ character.baseStats?.str || 0 }}
                    </span>
                    <span class="stat-bonus" 
                          *ngIf="hasStatChange(character, 'str')"
                          [class.positive]="getStatChange(character, 'str') > 0"
                          [class.negative]="getStatChange(character, 'str') < 0">
                      {{ getStatChange(character, 'str') > 0 ? '+' : '' }}{{ getStatChange(character, 'str') }}
                    </span>
                  </div>
                  <div class="stat-bar">
                    <div class="stat-bar-fill" [style.width.%]="getBaseStatPercentage(character, 'str')"></div>
                  </div>
                </div>
                <div class="stat-max-col">
                  <span class="stat-value">{{ character.maxStats?.str || 40 }}</span>
                </div>
              </div>
              <div class="growth-info">
                <span class="growth-value">{{ character.totalGrowthRate?.str || 0 }}%</span>
              </div>
            </div>

            <div class="stat-row" *ngIf="character.currentStats">
              <span class="stat-name">Mag</span>
              <div class="stat-data">
                <div class="stat-current-col">
                  <span class="stat-value" [class.maxed]="isBaseStatMaxed(character, 'mag')">
                    {{ character.currentStats?.mag || 0 }}
                  </span>
                </div>
                <div class="stat-base-col">
                  <div class="stat-value-group">
                    <span class="stat-base" [class.maxed]="isBaseStatMaxed(character, 'mag')">
                      {{ character.baseStats?.mag || 0 }}
                    </span>
                    <span class="stat-bonus" 
                          *ngIf="hasStatChange(character, 'mag')"
                          [class.positive]="getStatChange(character, 'mag') > 0"
                          [class.negative]="getStatChange(character, 'mag') < 0">
                      {{ getStatChange(character, 'mag') > 0 ? '+' : '' }}{{ getStatChange(character, 'mag') }}
                    </span>
                  </div>
                  <div class="stat-bar">
                    <div class="stat-bar-fill" [style.width.%]="getBaseStatPercentage(character, 'mag')"></div>
                  </div>
                </div>
                <div class="stat-max-col">
                  <span class="stat-value">{{ character.maxStats?.mag || 40 }}</span>
                </div>
              </div>
              <div class="growth-info">
                <span class="growth-value">{{ character.totalGrowthRate?.mag || 0 }}%</span>
              </div>
            </div>

            <div class="stat-row" *ngIf="character.currentStats">
              <span class="stat-name">Skl</span>
              <div class="stat-data">
                <div class="stat-current-col">
                  <span class="stat-value" [class.maxed]="isBaseStatMaxed(character, 'skl')">
                    {{ character.currentStats?.skl || 0 }}
                  </span>
                </div>
                <div class="stat-base-col">
                  <div class="stat-value-group">
                    <span class="stat-base" [class.maxed]="isBaseStatMaxed(character, 'skl')">
                      {{ character.baseStats?.skl || 0 }}
                    </span>
                    <span class="stat-bonus" 
                          *ngIf="hasStatChange(character, 'skl')"
                          [class.positive]="getStatChange(character, 'skl') > 0"
                          [class.negative]="getStatChange(character, 'skl') < 0">
                      {{ getStatChange(character, 'skl') > 0 ? '+' : '' }}{{ getStatChange(character, 'skl') }}
                    </span>
                  </div>
                  <div class="stat-bar">
                    <div class="stat-bar-fill" [style.width.%]="getBaseStatPercentage(character, 'skl')"></div>
                  </div>
                </div>
                <div class="stat-max-col">
                  <span class="stat-value">{{ character.maxStats?.skl || 40 }}</span>
                </div>
              </div>
              <div class="growth-info">
                <span class="growth-value">{{ character.totalGrowthRate?.skl || 0 }}%</span>
              </div>
            </div>

            <div class="stat-row" *ngIf="character.currentStats">
              <span class="stat-name">Spd</span>
              <div class="stat-data">
                <div class="stat-current-col">
                  <span class="stat-value" [class.maxed]="isBaseStatMaxed(character, 'spd')">
                    {{ character.currentStats?.spd || 0 }}
                  </span>
                </div>
                <div class="stat-base-col">
                  <div class="stat-value-group">
                    <span class="stat-base" [class.maxed]="isBaseStatMaxed(character, 'spd')">
                      {{ character.baseStats?.spd || 0 }}
                    </span>
                    <span class="stat-bonus" 
                          *ngIf="hasStatChange(character, 'spd')"
                          [class.positive]="getStatChange(character, 'spd') > 0"
                          [class.negative]="getStatChange(character, 'spd') < 0">
                      {{ getStatChange(character, 'spd') > 0 ? '+' : '' }}{{ getStatChange(character, 'spd') }}
                    </span>
                  </div>
                  <div class="stat-bar">
                    <div class="stat-bar-fill" [style.width.%]="getBaseStatPercentage(character, 'spd')"></div>
                  </div>
                </div>
                <div class="stat-max-col">
                  <span class="stat-value">{{ character.maxStats?.spd || 40 }}</span>
                </div>
              </div>
              <div class="growth-info">
                <span class="growth-value">{{ character.totalGrowthRate?.spd || 0 }}%</span>
              </div>
            </div>

            <div class="stat-row" *ngIf="character.currentStats">
              <span class="stat-name">Lck</span>
              <div class="stat-data">
                <div class="stat-current-col">
                  <span class="stat-value" [class.maxed]="isBaseStatMaxed(character, 'lck')">
                    {{ character.currentStats?.lck || 0 }}
                  </span>
                </div>
                <div class="stat-base-col">
                  <div class="stat-value-group">
                    <span class="stat-base" [class.maxed]="isBaseStatMaxed(character, 'lck')">
                      {{ character.baseStats?.lck || 0 }}
                    </span>
                    <span class="stat-bonus" 
                          *ngIf="hasStatChange(character, 'lck')"
                          [class.positive]="getStatChange(character, 'lck') > 0"
                          [class.negative]="getStatChange(character, 'lck') < 0">
                      {{ getStatChange(character, 'lck') > 0 ? '+' : '' }}{{ getStatChange(character, 'lck') }}
                    </span>
                  </div>
                  <div class="stat-bar">
                    <div class="stat-bar-fill" [style.width.%]="getBaseStatPercentage(character, 'lck')"></div>
                  </div>
                </div>
                <div class="stat-max-col">
                  <span class="stat-value">{{ character.maxStats?.lck || 40 }}</span>
                </div>
              </div>
              <div class="growth-info">
                <span class="growth-value">{{ character.totalGrowthRate?.lck || 0 }}%</span>
              </div>
            </div>

            <div class="stat-row" *ngIf="character.currentStats">
              <span class="stat-name">Def</span>
              <div class="stat-data">
                <div class="stat-current-col">
                  <span class="stat-value" [class.maxed]="isBaseStatMaxed(character, 'def')">
                    {{ character.currentStats?.def || 0 }}
                  </span>
                </div>
                <div class="stat-base-col">
                  <div class="stat-value-group">
                    <span class="stat-base" [class.maxed]="isBaseStatMaxed(character, 'def')">
                      {{ character.baseStats?.def || 0 }}
                    </span>
                    <span class="stat-bonus" 
                          *ngIf="hasStatChange(character, 'def')"
                          [class.positive]="getStatChange(character, 'def') > 0"
                          [class.negative]="getStatChange(character, 'def') < 0">
                      {{ getStatChange(character, 'def') > 0 ? '+' : '' }}{{ getStatChange(character, 'def') }}
                    </span>
                  </div>
                  <div class="stat-bar">
                    <div class="stat-bar-fill" [style.width.%]="getBaseStatPercentage(character, 'def')"></div>
                  </div>
                </div>
                <div class="stat-max-col">
                  <span class="stat-value">{{ character.maxStats?.def || 40 }}</span>
                </div>
              </div>
              <div class="growth-info">
                <span class="growth-value">{{ character.totalGrowthRate?.def || 0 }}%</span>
              </div>
            </div>

            <div class="stat-row" *ngIf="character.currentStats">
              <span class="stat-name">Res</span>
              <div class="stat-data">
                <div class="stat-current-col">
                  <span class="stat-value" [class.maxed]="isBaseStatMaxed(character, 'res')">
                    {{ character.currentStats?.res || 0 }}
                  </span>
                </div>
                <div class="stat-base-col">
                  <div class="stat-value-group">
                    <span class="stat-base" [class.maxed]="isBaseStatMaxed(character, 'res')">
                      {{ character.baseStats?.res || 0 }}
                    </span>
                    <span class="stat-bonus" 
                          *ngIf="hasStatChange(character, 'res')"
                          [class.positive]="getStatChange(character, 'res') > 0"
                          [class.negative]="getStatChange(character, 'res') < 0">
                      {{ getStatChange(character, 'res') > 0 ? '+' : '' }}{{ getStatChange(character, 'res') }}
                    </span>
                  </div>
                  <div class="stat-bar">
                    <div class="stat-bar-fill" [style.width.%]="getBaseStatPercentage(character, 'res')"></div>
                  </div>
                </div>
                <div class="stat-max-col">
                  <span class="stat-value">{{ character.maxStats?.res || 40 }}</span>
                </div>
              </div>
              <div class="growth-info">
                <span class="growth-value">{{ character.totalGrowthRate?.res || 0 }}%</span>
              </div>
            </div>

            <div class="stat-row stat-row-no-growth" *ngIf="character.currentStats">
              <span class="stat-name">Mov</span>
              <div class="stat-data">
                <div class="stat-current-col">
                  <span class="stat-value">{{ character.currentStats.mov }}</span>
                </div>
                <div class="stat-base-col">
                  <div class="stat-value-group">
                    <span class="stat-base">{{ character.currentStats.mov }}</span>
                  </div>
                  <div class="stat-bar">
                    <div class="stat-bar-fill" [style.width.%]="getStatPercentage(character.currentStats.mov, 10)"></div>
                  </div>
                </div>
                <div class="stat-max-col">
                  <span class="stat-value">10</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Column 2: Weapon Ranks -->
          <div class="weapon-ranks-column" *ngIf="character.weaponRanks && character.weaponRanks.length > 0">
            <h2 class="section-header">Weapon Ranks</h2>
              <div class="weapon-rank-item" *ngFor="let weapon of getSortedWeaponRanks(character)" 
                   [class.active]="weapon.isActive"
                   [matTooltip]="'Experience: ' + weapon.weaponExperience + ' / ' + getNextRankExp(weapon.weaponRank)"
                   matTooltipPosition="above">
                <div class="weapon-rank-info">
                  <span class="weapon-type">{{ weapon.weaponType }}</span>
                  <span class="weapon-rank-badge" 
                        [class.rank-s]="weapon.weaponRank === 'S'" 
                        [class.rank-a]="weapon.weaponRank === 'A'"
                        [class.rank-b]="weapon.weaponRank === 'B'"
                        [class.rank-c]="weapon.weaponRank === 'C'"
                        [class.rank-d]="weapon.weaponRank === 'D'"
                        [class.rank-e]="weapon.weaponRank === 'E'">
                    {{ weapon.weaponRank }}
                  </span>
                </div>
                <div class="weapon-exp-bar">
                  <div class="weapon-exp-fill" 
                       [style.width.%]="getWeaponExpPercentage(weapon.weaponExperience, weapon.weaponRank)"
                       [class.rank-s]="weapon.weaponRank === 'S'" 
                       [class.rank-a]="weapon.weaponRank === 'A'"
                       [class.rank-b]="weapon.weaponRank === 'B'"
                       [class.rank-c]="weapon.weaponRank === 'C'"
                       [class.rank-d]="weapon.weaponRank === 'D'"
                       [class.rank-e]="weapon.weaponRank === 'E'"></div>
                </div>
              </div>
          </div>

          <!-- Column 3: Inventory/Equipment -->
          <div class="inventory-column">
            <h2 class="section-header">Equipment ({{ getInventoryCount(character) }}/5)</h2>
            
            <!-- Special Equipped Weapon Slot -->
            <div class="special-weapon-slot" *ngIf="character.equippedWeapon && !hasEquippedWeaponInInventory(character)">
              <div class="equipment-item equipped special-equipped"
                   [class.expanded]="isSpecialWeaponExpanded"
                   (click)="toggleSpecialWeaponExpansion()">
                <span class="equipment-icon">{{ getItemIcon(character.equippedWeapon) }}</span>
                <div class="equipment-details">
                  <span class="equipment-name">{{ character.equippedWeapon.name }}</span>
                  <div class="equipment-meta">
                    <span class="equipment-type">{{ character.equippedWeapon.weaponType }}</span>
                    <span class="equipment-badge equipped-badge">‚öî Equipped</span>
                    <span class="equipment-uses" *ngIf="character.equippedWeapon.uses">{{ character.equippedWeapon.uses }}</span>
                  </div>
                </div>
              </div>
              
              <div class="item-details-expanded" *ngIf="isSpecialWeaponExpanded" [@fadeInOut]>
                <div class="detail-section-content">
                  <!-- Description -->
                  <p class="item-description" *ngIf="character.equippedWeapon.description">
                    {{ character.equippedWeapon.description }}
                  </p>

                  <!-- Stats Grid -->
                  <div class="item-stats-row">
                    <div class="item-stat" *ngIf="character.equippedWeapon.might !== null && character.equippedWeapon.might !== undefined">
                      <span class="stat-label">Might:</span>
                      <span class="stat-value">{{ character.equippedWeapon.might }}</span>
                    </div>
                    <div class="item-stat" *ngIf="character.equippedWeapon.hit !== null && character.equippedWeapon.hit !== undefined">
                      <span class="stat-label">Hit:</span>
                      <span class="stat-value">{{ character.equippedWeapon.hit }}%</span>
                    </div>
                    <div class="item-stat" *ngIf="character.equippedWeapon.crit !== null && character.equippedWeapon.crit !== undefined">
                      <span class="stat-label">Crit:</span>
                      <span class="stat-value">{{ character.equippedWeapon.crit }}%</span>
                    </div>
                    <div class="item-stat" *ngIf="character.equippedWeapon.range">
                      <span class="stat-label">Range:</span>
                      <span class="stat-value">{{ character.equippedWeapon.range }}</span>
                    </div>
                    <div class="item-stat" *ngIf="character.equippedWeapon.rank">
                      <span class="stat-label">Rank:</span>
                      <span class="stat-value">{{ character.equippedWeapon.rank }}</span>
                    </div>
                    <div class="item-stat" *ngIf="character.equippedWeapon.worth">
                      <span class="stat-label">Worth:</span>
                      <span class="stat-value">{{ character.equippedWeapon.worth }}G</span>
                    </div>
                    <div class="item-stat" *ngIf="character.equippedWeapon.baseHP !== null && character.equippedWeapon.baseHP !== undefined">
                      <span class="stat-label">Base HP:</span>
                      <span class="stat-value">{{ character.equippedWeapon.baseHP }}</span>
                    </div>
                  </div>

                  <!-- Properties -->
                  <div class="item-properties" *ngIf="character.equippedWeapon.isMagical || character.equippedWeapon.isBrave || character.equippedWeapon.doesEffectiveDamage">
                    <span class="property-badge" *ngIf="character.equippedWeapon.isMagical">üîÆ Magical</span>
                    <span class="property-badge" *ngIf="character.equippedWeapon.isBrave">‚ö° Brave</span>
                    <span class="property-badge" *ngIf="character.equippedWeapon.doesEffectiveDamage">üí• Effective</span>
                  </div>

                  <!-- Effective Against -->
                  <div class="item-effective" *ngIf="character.equippedWeapon.effectiveUnitTypes && character.equippedWeapon.effectiveUnitTypes.length > 0">
                    <div class="effective-title">Effective Against:</div>
                    <div class="effective-types">
                      <span class="effective-type" *ngFor="let type of character.equippedWeapon.effectiveUnitTypes">{{ type }}</span>
                    </div>
                  </div>

                  <!-- Stat Bonuses -->
                  <div class="item-stat-bonuses" *ngIf="character.equippedWeapon.statBonus?.stats">
                    <div class="bonuses-title">Stat Bonuses:</div>
                    <div class="bonus-grid">
                      <span class="bonus-item" *ngIf="character.equippedWeapon.statBonus.stats.hp">HP: {{ character.equippedWeapon.statBonus.stats.hp > 0 ? '+' : '' }}{{ character.equippedWeapon.statBonus.stats.hp }}</span>
                      <span class="bonus-item" *ngIf="character.equippedWeapon.statBonus.stats.str">Str: {{ character.equippedWeapon.statBonus.stats.str > 0 ? '+' : '' }}{{ character.equippedWeapon.statBonus.stats.str }}</span>
                      <span class="bonus-item" *ngIf="character.equippedWeapon.statBonus.stats.mag">Mag: {{ character.equippedWeapon.statBonus.stats.mag > 0 ? '+' : '' }}{{ character.equippedWeapon.statBonus.stats.mag }}</span>
                      <span class="bonus-item" *ngIf="character.equippedWeapon.statBonus.stats.skl">Skl: {{ character.equippedWeapon.statBonus.stats.skl > 0 ? '+' : '' }}{{ character.equippedWeapon.statBonus.stats.skl }}</span>
                      <span class="bonus-item" *ngIf="character.equippedWeapon.statBonus.stats.spd">Spd: {{ character.equippedWeapon.statBonus.stats.spd > 0 ? '+' : '' }}{{ character.equippedWeapon.statBonus.stats.spd }}</span>
                      <span class="bonus-item" *ngIf="character.equippedWeapon.statBonus.stats.lck">Lck: {{ character.equippedWeapon.statBonus.stats.lck > 0 ? '+' : '' }}{{ character.equippedWeapon.statBonus.stats.lck }}</span>
                      <span class="bonus-item" *ngIf="character.equippedWeapon.statBonus.stats.def">Def: {{ character.equippedWeapon.statBonus.stats.def > 0 ? '+' : '' }}{{ character.equippedWeapon.statBonus.stats.def }}</span>
                      <span class="bonus-item" *ngIf="character.equippedWeapon.statBonus.stats.res">Res: {{ character.equippedWeapon.statBonus.stats.res > 0 ? '+' : '' }}{{ character.equippedWeapon.statBonus.stats.res }}</span>
                      <span class="bonus-item" *ngIf="character.equippedWeapon.statBonus.stats.mov">Mov: {{ character.equippedWeapon.statBonus.stats.mov > 0 ? '+' : '' }}{{ character.equippedWeapon.statBonus.stats.mov }}</span>
                    </div>
                  </div>
                </div>
              </div>
              <div class="special-weapon-divider"></div>
            </div>
            
            <div class="equipment-list">
              <div *ngFor="let item of getInventorySlots(character); let i = index" 
                   class="equipment-item-wrapper">
                <div class="equipment-item clickable"
                     [class.equipped]="item && isEquipped(item, character)"
                     [class.empty-slot]="!item"
                     [class.expanded]="isItemExpanded(i)"
                     (click)="item && toggleItemExpansion(i)">
                  <span class="equipment-icon">{{ item ? getItemIcon(item) : 'üì¶' }}</span>
                  <div class="equipment-details">
                    <span class="equipment-name">{{ item ? item.name : 'Empty' }}</span>
                    <div class="equipment-meta" *ngIf="item">
                      <span class="equipment-type">{{ item.weaponType }}</span>
                      <span class="equipment-badge equipped-badge" *ngIf="isEquipped(item, character)">‚öî Equipped</span>
                      <span class="equipment-uses" *ngIf="item.uses">{{ item.uses }}</span>
                    </div>
                  </div>
                  
                  <button *ngIf="item && canEquipItem(item) && !isEquipped(item, character)" 
                          class="equip-weapon-button"
                          (click)="equipWeapon(item, $event)"
                          title="Equip">
                    ‚öî
                  </button>
                  <button *ngIf="item && isEquipped(item, character)" 
                          class="unequip-weapon-button"
                          (click)="unequipWeapon($event)"
                          title="Unequip">
                    ‚úñ
                  </button>
                  <button *ngIf="item && isConsumable(item) && canUseItem(item)"
                          class="use-item-button"
                          (click)="openUseItemDialog(item, $event)"
                          title="Use Item">
                    ‚ú®
                  </button>
                </div>
                
                <div class="item-details-expanded" *ngIf="item && isItemExpanded(i)" [@fadeInOut]>
                  <div class="detail-section-content">
                    <!-- Description -->
                    <p class="item-description" *ngIf="item.description">
                      {{ item.description }}
                    </p>

                    <!-- Stats Grid -->
                    <div class="item-stats-row">
                      <div class="item-stat" *ngIf="item.might !== null && item.might !== undefined">
                        <span class="stat-label">Might:</span>
                        <span class="stat-value">{{ item.might }}</span>
                      </div>
                      <div class="item-stat" *ngIf="item.hit !== null && item.hit !== undefined">
                        <span class="stat-label">Hit:</span>
                        <span class="stat-value">{{ item.hit }}%</span>
                      </div>
                      <div class="item-stat" *ngIf="item.crit !== null && item.crit !== undefined">
                        <span class="stat-label">Crit:</span>
                        <span class="stat-value">{{ item.crit }}%</span>
                      </div>
                      <div class="item-stat" *ngIf="item.range">
                        <span class="stat-label">Range:</span>
                        <span class="stat-value">{{ item.range }}</span>
                      </div>
                      <div class="item-stat" *ngIf="item.rank">
                        <span class="stat-label">Rank:</span>
                        <span class="stat-value">{{ item.rank }}</span>
                      </div>
                      <div class="item-stat" *ngIf="item.worth">
                        <span class="stat-label">Worth:</span>
                        <span class="stat-value">{{ item.worth }}G</span>
                      </div>
                      <div class="item-stat" *ngIf="item.baseHP !== null && item.baseHP !== undefined">
                        <span class="stat-label">Base HP:</span>
                        <span class="stat-value">{{ item.baseHP }}</span>
                      </div>
                    </div>

                    <!-- Properties -->
                    <div class="item-properties" *ngIf="item.isMagical || item.isBrave || item.doesEffectiveDamage">
                      <span class="property-badge" *ngIf="item.isMagical">üîÆ Magical</span>
                      <span class="property-badge" *ngIf="item.isBrave">‚ö° Brave</span>
                      <span class="property-badge" *ngIf="item.doesEffectiveDamage">
                        üí• Effective
                        <ng-container *ngIf="item.effectiveUnitTypes && item.effectiveUnitTypes.length > 0">
                          :
                          <span *ngFor="let type of item.effectiveUnitTypes">{{ type }} |</span>
                        </ng-container>
                      </span>
                    </div>

                    <!-- Effective Against -->
                    <div class="item-effective" *ngIf="item.effectiveUnitTypes && item.effectiveUnitTypes.length > 0">
                      <div class="effective-title">Effective Against:</div>
                      <div class="effective-types">
                        <span class="effective-type" *ngFor="let type of item.effectiveUnitTypes">{{ type }}</span>
                      </div>
                    </div>

                    <!-- Stat Bonuses -->
                    <div class="item-stat-bonuses" *ngIf="item.statBonus?.stats">
                      <div class="bonuses-title">Stat Bonuses:</div>
                      <div class="bonus-grid">
                        <span class="bonus-item" *ngIf="item.statBonus.stats.hp">HP: {{ item.statBonus.stats.hp > 0 ? '+' : '' }}{{ item.statBonus.stats.hp }}</span>
                        <span class="bonus-item" *ngIf="item.statBonus.stats.str">Str: {{ item.statBonus.stats.str > 0 ? '+' : '' }}{{ item.statBonus.stats.str }}</span>
                        <span class="bonus-item" *ngIf="item.statBonus.stats.mag">Mag: {{ item.statBonus.stats.mag > 0 ? '+' : '' }}{{ item.statBonus.stats.mag }}</span>
                        <span class="bonus-item" *ngIf="item.statBonus.stats.skl">Skl: {{ item.statBonus.stats.skl > 0 ? '+' : '' }}{{ item.statBonus.stats.skl }}</span>
                        <span class="bonus-item" *ngIf="item.statBonus.stats.spd">Spd: {{ item.statBonus.stats.spd > 0 ? '+' : '' }}{{ item.statBonus.stats.spd }}</span>
                        <span class="bonus-item" *ngIf="item.statBonus.stats.lck">Lck: {{ item.statBonus.stats.lck > 0 ? '+' : '' }}{{ item.statBonus.stats.lck }}</span>
                        <span class="bonus-item" *ngIf="item.statBonus.stats.def">Def: {{ item.statBonus.stats.def > 0 ? '+' : '' }}{{ item.statBonus.stats.def }}</span>
                        <span class="bonus-item" *ngIf="item.statBonus.stats.res">Res: {{ item.statBonus.stats.res > 0 ? '+' : '' }}{{ item.statBonus.stats.res }}</span>
                        <span class="bonus-item" *ngIf="item.statBonus.stats.mov">Mov: {{ item.statBonus.stats.mov > 0 ? '+' : '' }}{{ item.statBonus.stats.mov }}</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="convoy-access-wrapper">
              <button class="convoy-access-button" (click)="openConvoy()" title="Access Convoy">
                <span class="convoy-icon">üì¶</span>
                <span class="convoy-text">Convoy</span>
              </button>
            </div>
          </div>

          <!-- Column 4: Abilities -->
          <div class="abilities-column">
            <div class="inventory-section" *ngIf="character.personalAbility">
              <h2 class="section-header">Personal</h2>
              <div class="personal-ability-wrapper">
                <div class="ability-item personal-ability clickable"
                     [class.expanded]="expandedPersonalAbility"
                     (click)="togglePersonalAbilityExpansion()">
                  <span class="ability-icon">‚≠ê</span>
                  <div class="ability-content">
                    <span class="ability-name">{{ character.personalAbility.name }}</span>
                  </div>
                </div>
                <div class="ability-details-expanded" *ngIf="expandedPersonalAbility" [@fadeInOut]>
                  <p class="ability-description">{{ character.personalAbility.description }}</p>
                </div>
              </div>
            </div>

            <div class="inventory-section">
              <div class="section-header-with-action">
                <h2 class="section-header">Abilities ({{ getEquippedAbilitiesCount(character) }}/5)</h2>
                <button class="manage-button" (click)="openAbilityManagementModal()" title="Manage Abilities">
                  <span class="button-icon">‚öôÔ∏è</span>
                  <span class="button-text">Manage</span>
                </button>
              </div>
              
              <div class="abilities-list">
                <ng-container *ngFor="let ability of getAbilitySlots(character); let i = index">
                  <div *ngIf="!ability"
                       class="ability-item empty-slot">
                    <span class="ability-icon">üì¶</span>
                    <span class="ability-name">Empty</span>
                  </div>
                  
                  <div *ngIf="ability" class="ability-item-wrapper">
                    <div class="ability-item clickable"
                         [class.expanded]="isAbilityExpanded(i)"
                         (click)="toggleAbilityExpansion(i)">
                      <span class="ability-icon">‚ú®</span>
                      <div class="ability-content">
                        <span class="ability-name">{{ ability.name }}</span>
                      </div>
                    </div>
                    <div class="ability-details-expanded" *ngIf="isAbilityExpanded(i)" [@fadeInOut]>
                      <p class="ability-description">{{ ability.description }}</p>
                    </div>
                  </div>
                </ng-container>
              </div>
            </div>
          </div>

        </div>
      </div>

      <!-- Biography Tab -->
      <div class="tab-panel" *ngIf="selectedTab === 'biography'">
        <div class="biography-container">
          <h2 class="section-header">Character Information</h2>
          
          <div class="biography-section">
            <div class="bio-info-grid">
              <div class="bio-info-item">
                <span class="bio-label">Name</span>
                <span class="bio-value">{{ character.biography?.name }}</span>
              </div>
              
              <div class="bio-info-item">
                <span class="bio-label">Gender</span>
                <span class="bio-value">{{ character.biography?.gender }}</span>
              </div>
              
              <div class="bio-info-item">
                <span class="bio-label">Race</span>
                <span class="bio-value">{{ character.biography?.raceChoice?.racialType }}</span>
              </div>
              
              <div class="bio-info-item" *ngIf="character.asset">
                <span class="bio-label">Asset</span>
                <span class="bio-value asset-text">+{{ character.asset.assetChoice }}</span>
              </div>
              
              <div class="bio-info-item" *ngIf="character.flaw">
                <span class="bio-label">Flaw</span>
                <span class="bio-value flaw-text">-{{ character.flaw.flawChoice }}</span>
              </div>
              
              <div class="bio-info-item" *ngIf="character.startingClass">
                <span class="bio-label">Starting Class</span>
                <span class="bio-value">{{ character.startingClass }}</span>
              </div>
              
              <div class="bio-info-item" *ngIf="character.heartSealClass">
                <span class="bio-label">Heart Seal Class</span>
                <span class="bio-value">{{ character.heartSealClass }}</span>
              </div>
            </div>
            
            <div class="bio-background" *ngIf="character.biography?.background">
              <h3 class="bio-section-title">Background</h3>
              <p class="bio-text">{{ character.biography.background }}</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Supports Tab -->
      <div class="tab-panel" *ngIf="selectedTab === 'supports'">
        <div class="supports-container">
          <h2 class="section-header">Character Supports</h2>
          
          <div class="supports-section">
            <div class="supports-placeholder">
              <p>Support relationships will be displayed here.</p>
              <p class="placeholder-note">This feature is under development.</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Skills Tab (unchanged) -->
      <div class="tab-panel" *ngIf="selectedTab === 'skills'">
        <div class="skills-container">
          <h2 class="section-header">Skills</h2>
          <div class="skills-list">
            <div class="skill-item clickable" 
                 *ngFor="let skill of character?.skills; let i = index"
                 [class.proficient]="skill?.isProficient"
                 [class.expanded]="isSkillExpanded(i)"
                 (click)="toggleSkillExpansion(i)">
              <div class="skill-compact">
                <span class="skill-icon" *ngIf="skill?.isProficient">‚≠ê</span>
                <div class="skill-main-info">
                  <span class="skill-name">{{ skill?.skillType }}</span>
                  <span class="skill-stat-type">{{ skill?.statType }}</span>
                </div>
                <span class="skill-score">{{ skill?.score }}</span>
              </div>
              
              <div class="skill-details-expanded" *ngIf="isSkillExpanded(i)" [@fadeInOut]>
                <div class="skill-stats-expanded">
                  <div class="skill-stat-item">
                    <span class="stat-label">Attribute</span>
                    <span class="stat-value">{{ skill?.attribute }}</span>
                  </div>
                  <div class="skill-stat-item">
                    <span class="stat-label">Bonus</span>
                    <span class="stat-value bonus-value">+{{ skill?.bonus }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div> <!-- Close tab-content -->

  </div> <!-- Close character-content -->
</div> <!-- Close character-detail-wrapper -->

<!-- Loading State -->
<div class="loading-container" *ngIf="!(character$ | async)">
  <div class="loading-spinner">Loading character details...</div>
</div>

<!-- Ability Management Dialog Template -->
<ng-template #abilityManagementDialog>
  <h2 mat-dialog-title class="dialog-title">
    <span class="dialog-icon">‚öôÔ∏è</span>
    Ability Management
  </h2>
  
  <mat-dialog-content class="dialog-content">
    <div class="ability-management-content" *ngIf="character$ | async as character">
      
      <!-- Equipped Abilities Section -->
      <div class="equipped-abilities-section">
        <h3 class="section-subtitle">Equipped Abilities ({{ getEquippedAbilitiesCount(character) }}/5)</h3>
        
        <div class="equipped-abilities-list" *ngIf="character.equippedAbilities && character.equippedAbilities.length > 0">
          <div *ngFor="let ability of character.equippedAbilities" 
               class="management-ability-item equipped">
            <span class="ability-icon">‚ú®</span>
            <div class="ability-info">
              <div class="ability-header-row">
                <span class="ability-name">{{ ability.name }}</span>
                <button class="unequip-btn" 
                        (click)="unequipAbility(ability)">
                  <span class="button-icon">‚àí</span>
                  Unequip
                </button>
              </div>
              <p class="ability-description">{{ ability.description }}</p>
            </div>
          </div>
        </div>

        <div class="no-abilities-message" *ngIf="!character.equippedAbilities || character.equippedAbilities.length === 0">
          <span class="message-icon">üì≠</span>
          <p>No equipped abilities</p>
        </div>
      </div>

      <!-- Divider -->
      <div class="section-divider"></div>

      <!-- Available Abilities Section -->
      <div class="available-abilities-section">
        <h3 class="section-subtitle">Available Abilities ({{ getUnequippedAbilities(character).length }})</h3>
        
        <div class="available-abilities-list" *ngIf="getUnequippedAbilities(character).length > 0">
          <div *ngFor="let ability of getUnequippedAbilities(character)" 
               class="management-ability-item available">
            <span class="ability-icon">‚ú®</span>
            <div class="ability-info">
              <div class="ability-header-row">
                <span class="ability-name">{{ ability.name }}</span>
                <button class="equip-btn" 
                        (click)="equipAbility(ability)"
                        [disabled]="!hasAvailableAbilitySlots(character)">
                  <span class="button-icon">+</span>
                  Equip
                </button>
              </div>
              <p class="ability-description">{{ ability.description }}</p>
            </div>
          </div>
        </div>

        <div class="no-abilities-message" *ngIf="getUnequippedAbilities(character).length === 0">
          <span class="message-icon">üì≠</span>
          <p>No unequipped abilities available</p>
        </div>
      </div>

    </div>
  </mat-dialog-content>
  
  <mat-dialog-actions align="end" class="dialog-actions">
    <button mat-button mat-dialog-close class="cancel-button">Close</button>
  </mat-dialog-actions>
</ng-template>

<!-- Use Item Dialog Template -->
<ng-template #useItemDialog>
  <h2 mat-dialog-title class="dialog-title">
    <span class="dialog-icon">‚ú®</span>
    Use Item
  </h2>
  
  <mat-dialog-content class="dialog-content">
    <div class="use-item-content" *ngIf="itemToUse">
      
      <!-- Item Name -->
      <h3 class="item-title">{{ itemToUse.name }}</h3>
      
      <!-- Item Description -->
      <p class="item-description" *ngIf="itemToUse.description">
        {{ itemToUse.description }}
      </p>

      <!-- Temporary Items Warning -->
      <div class="warning-message" *ngIf="getItemType(itemToUse) === 'temporary'">
        <span class="warning-icon">‚ö†Ô∏è</span>
        <p>Temporary items cannot be used directly. They provide passive bonuses when in your inventory.</p>
      </div>

      <!-- Permanent/Healing Items Confirmation -->
      <div class="confirmation-section" *ngIf="getItemType(itemToUse) === 'permanent' || getItemType(itemToUse) === 'healing'">
        <p class="confirmation-text">Would you like to use this item?</p>
        <p class="warning-note" *ngIf="getItemType(itemToUse) === 'permanent'">
          ‚ö†Ô∏è This is a permanent effect and cannot be undone.
        </p>
      </div>

      <!-- Promotion Items Class Selection -->
      <div class="promotion-section" *ngIf="getItemType(itemToUse) === 'promotion'">
        <p class="promotion-instruction">Select a class to promote/reclass to:</p>
        
        <div class="level-requirement" *ngIf="currentCharacter && currentCharacter.level < 10">
          <span class="error-icon">‚ùå</span>
          <p>Promotion items can only be used at level 10 or higher.</p>
          <p>Current Level: {{ currentCharacter.level }}</p>
        </div>

        <div class="class-selection" *ngIf="currentCharacter && currentCharacter.level >= 10">
          <mat-form-field appearance="outline" class="class-dropdown">
            <mat-label>Choose Class</mat-label>
            <mat-select [(value)]="selectedPromotionClass">
              <mat-option *ngFor="let className of availablePromotionClasses" [value]="className">
                {{ className }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <div class="no-classes-warning" *ngIf="availablePromotionClasses.length === 0">
            <span class="warning-icon">‚ö†Ô∏è</span>
            <p>No available classes for this promotion item.</p>
          </div>

          <!-- Weapon Type Selection for Dread Fighter -->
          <div class="weapon-type-selection" *ngIf="selectedPromotionClass === 'Dread Fighter'">
            <p class="weapon-instruction">Choose Weapon Type:</p>
            <mat-radio-group [(ngModel)]="selectedWeaponType" class="weapon-radio-group">
              <mat-radio-button value="Tome" class="weapon-radio">
                <span class="weapon-icon">üìñ</span>
                Tome
              </mat-radio-button>
              <mat-radio-button value="Shuriken" class="weapon-radio">
                <span class="weapon-icon">üó°Ô∏è</span>
                Shuriken
              </mat-radio-button>
            </mat-radio-group>
          </div>
        </div>
      </div>

    </div>
  </mat-dialog-content>
  
  <mat-dialog-actions align="end" class="dialog-actions">
    <button mat-button (click)="cancelUseItem()" class="cancel-button">Cancel</button>
    <button mat-raised-button 
            (click)="confirmUseItem()" 
            class="confirm-button"
            [disabled]="getItemType(itemToUse) === 'promotion' && (!selectedPromotionClass || (isDreadScroll(itemToUse) && !selectedWeaponType))">
      <span class="button-icon">‚ú®</span>
      Use Item
    </button>
  </mat-dialog-actions>
</ng-template>
