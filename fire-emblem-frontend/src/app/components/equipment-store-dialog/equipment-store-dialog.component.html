<div class="equipment-store-container">
  <div class="store-header">
    <h2 class="store-title">‚öîÔ∏è Equipment Store</h2>
    <div class="gold-display">
      <span class="gold-icon">üí∞</span>
      <span class="gold-amount">{{ currentGold }}</span>
      <span class="gold-label">Gold</span>
    </div>
  </div>

  <div class="store-content" *ngIf="!loading">
    <!-- Tabs -->
    <div class="equipment-tabs">
      <button *ngFor="let type of weaponTypes"
              class="tab-button"
              [class.active]="selectedTab === type"
              (click)="selectTab(type)">
        <span class="tab-label">{{ type }}</span>
        <span class="tab-count">({{ getTabCount(type) }})</span>
      </button>
    </div>

    <!-- Purchased Items Summary -->
    <div class="purchased-summary" *ngIf="purchasedItems.length > 0">
      <h3 class="summary-title">üì¶ Cart ({{ purchasedItems.length }} items)</h3>
      <div class="purchased-items-list">
        <div *ngFor="let item of purchasedItems; let i = index" class="purchased-item">
          <span class="item-name">{{ item.name }}</span>
          <span class="item-worth">{{ item.worth }}G</span>
          <button class="remove-btn" (click)="removePurchasedItem(item)" title="Remove from cart">‚úï</button>
        </div>
      </div>
    </div>

    <!-- Available Equipment -->
    <div class="equipment-grid">
      <div *ngFor="let item of filteredEquipment" 
           class="equipment-card"
           [class.purchased]="isPurchased(item)"
           [class.expanded]="isItemExpanded(item.id)">
        
        <!-- Equipment Header -->
        <div class="equipment-header" (click)="toggleItemExpansion(item.id)">
          <div class="equipment-main">
            <span class="equipment-icon">{{ getItemIcon(item) }}</span>
            <div class="equipment-info">
              <h4 class="equipment-name">{{ item.name }}</h4>
              <span class="equipment-type-badge">{{ item.weaponType }}</span>
            </div>
          </div>
          <div class="equipment-price">
            <span class="price-amount">{{ item.worth }}</span>
            <span class="price-label">G</span>
          </div>
        </div>

        <!-- Expanded Details -->
        <div class="equipment-details" *ngIf="isItemExpanded(item.id)">
          <p class="equipment-description" *ngIf="item.description">{{ item.description }}</p>
          
          <!-- Stats Grid -->
          <div class="stats-grid">
            <div class="stat-item" *ngIf="item.might !== null && item.might !== undefined">
              <span class="stat-label">Might:</span>
              <span class="stat-value">{{ item.might }}</span>
            </div>
            <div class="stat-item" *ngIf="item.hit !== null && item.hit !== undefined">
              <span class="stat-label">Hit:</span>
              <span class="stat-value">{{ item.hit }}%</span>
            </div>
            <div class="stat-item" *ngIf="item.crit !== null && item.crit !== undefined">
              <span class="stat-label">Crit:</span>
              <span class="stat-value">{{ item.crit }}%</span>
            </div>
            <div class="stat-item" *ngIf="item.range">
              <span class="stat-label">Range:</span>
              <span class="stat-value">{{ item.range }}</span>
            </div>
            <div class="stat-item" *ngIf="item.uses">
              <span class="stat-label">Uses:</span>
              <span class="stat-value">{{ item.uses }}</span>
            </div>
            <div class="stat-item" *ngIf="item.rank">
              <span class="stat-label">Rank:</span>
              <span class="stat-value">{{ item.rank }}</span>
            </div>
          </div>

          <!-- Properties -->
          <div class="properties" *ngIf="item.isMagical || item.isBrave || item.doesEffectiveDamage">
            <span class="property-badge" *ngIf="item.isMagical">üîÆ Magical</span>
            <span class="property-badge" *ngIf="item.isBrave">‚ö° Brave</span>
            <span class="property-badge" *ngIf="item.doesEffectiveDamage">
              üí• Effective
              <ng-container *ngIf="item.effectiveUnitTypes && item.effectiveUnitTypes.length > 0">
                :
                <span *ngFor="let type of item.effectiveUnitTypes">{{ type }} </span>
              </ng-container>
            </span>
          </div>

          <!-- Stat Bonuses -->
          <div class="stat-bonuses" *ngIf="item.statBonus && item.statBonus.stats">
            <h5 class="bonuses-title">Stat Bonuses:</h5>
            <div class="bonus-grid">
              <span class="bonus-item" *ngIf="item.statBonus.stats.hp">HP: +{{ item.statBonus.stats.hp }}</span>
              <span class="bonus-item" *ngIf="item.statBonus.stats.str">STR: +{{ item.statBonus.stats.str }}</span>
              <span class="bonus-item" *ngIf="item.statBonus.stats.mag">MAG: +{{ item.statBonus.stats.mag }}</span>
              <span class="bonus-item" *ngIf="item.statBonus.stats.skl">SKL: +{{ item.statBonus.stats.skl }}</span>
              <span class="bonus-item" *ngIf="item.statBonus.stats.spd">SPD: +{{ item.statBonus.stats.spd }}</span>
              <span class="bonus-item" *ngIf="item.statBonus.stats.lck">LCK: +{{ item.statBonus.stats.lck }}</span>
              <span class="bonus-item" *ngIf="item.statBonus.stats.def">DEF: +{{ item.statBonus.stats.def }}</span>
              <span class="bonus-item" *ngIf="item.statBonus.stats.res">RES: +{{ item.statBonus.stats.res }}</span>
            </div>
          </div>

          <!-- Buy Button -->
          <button class="buy-btn" 
                  (click)="initiratePurchase(item); $event.stopPropagation()"
                  [disabled]="parseWorth(item.worth) > currentGold">
            <span class="btn-icon">üõí</span>
            <span class="btn-text">Buy</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div class="loading-state" *ngIf="loading">
    <div class="spinner"></div>
    <p>Loading equipment...</p>
  </div>

  <!-- Store Actions -->
  <div class="store-actions">
    <button mat-button (click)="close()" class="cancel-btn">Cancel</button>
    <button mat-raised-button 
            (click)="finalizePurchases()" 
            class="confirm-btn"
            [disabled]="purchasedItems.length === 0">
      Complete Purchase
    </button>
  </div>
</div>

<!-- Confirmation Dialog Overlay -->
<div class="confirmation-overlay" *ngIf="showConfirmDialog" (click)="cancelPurchase()">
  <div class="confirmation-dialog" (click)="$event.stopPropagation()">
    <h3 class="confirm-title">{{ confirmError || 'Confirm Purchase' }}</h3>
    
    <div class="confirm-content" *ngIf="!confirmError && confirmingItem">
      <p class="confirm-message">Purchase {{ confirmingItem.name }} for {{ confirmingItem.worth }}G?</p>
      <div class="confirm-details">
        <span class="detail-label">Current Gold:</span>
        <span class="detail-value">{{ currentGold }}G</span>
      </div>
      <div class="confirm-details">
        <span class="detail-label">After Purchase:</span>
        <span class="detail-value">{{ currentGold - parseWorth(confirmingItem.worth) }}G</span>
      </div>
    </div>

    <div class="confirm-error" *ngIf="confirmError">
      <p class="error-icon">‚ö†Ô∏è</p>
      <p class="error-message">{{ confirmError }}</p>
    </div>

    <div class="confirm-actions" *ngIf="!confirmError">
      <button mat-button (click)="cancelPurchase()" class="confirm-cancel-btn">Cancel</button>
      <button mat-raised-button (click)="confirmPurchase()" class="confirm-ok-btn">Confirm</button>
    </div>
  </div>
</div>
